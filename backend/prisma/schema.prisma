// ============================================================
// prisma/schema.prisma - SaaS Engine Pro
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum Role {
  USER
  ADMIN
  FOUNDER
}

enum PlanTier {
  FREE
  PRO
  ENTERPRISE
}

enum AIDraftStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AuditAction {
  // Module lifecycle
  MODULE_CREATED
  MODULE_ARCHIVED
  MODULE_VERSION_CREATED
  
  // AI Draft governance
  MODULE_APPROVED
  MODULE_REJECTED
  
  // User governance
  PLAN_UPGRADED
  PLAN_DOWNGRADED
  ROLE_CHANGED
  
  // Future-proofing
  USER_CREATED
  USER_DELETED
  ACCESS_GRANTED
  ACCESS_REVOKED
}

enum AuditEntityType {
  USER
  MODULE
  AIDRAFT
  SUBSCRIPTION
}

// ============================================================
// MODELS
// ============================================================

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String

  role         Role      @default(USER)
  plan         PlanTier  @default(FREE)

  // Relations
  moduleAccesses   ModuleAccess[]
  aiModuleDrafts   AIModuleDraft[]
  auditLogs        AuditLog[]   @relation("AuditLogPerformedBy")
  publishedModules Module[]     @relation("ModulePublishedBy")

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Module {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?

  minPlan     PlanTier @default(FREE)

  // Versioning fields
  version           Int       @default(1)
  isArchived        Boolean   @default(false)
  publishedAt       DateTime?
  publishedByUserId String?
  publishedByUser   User?     @relation("ModulePublishedBy", fields: [publishedByUserId], references: [id])

  // Traceability: which AI draft created this module (null if manual)
  sourceAIDraftId   String?
  sourceAIDraft     AIModuleDraft? @relation("ModuleFromDraft", fields: [sourceAIDraftId], references: [id])

  // Relations
  moduleAccesses ModuleAccess[]

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Constraints & Indexes
  @@unique([slug, version])
  @@index([slug])
  @@index([minPlan])
  @@index([isArchived])
  @@index([publishedAt])
}

model ModuleAccess {
  id        String   @id @default(cuid())
  userId    String
  moduleId  String

  user      User     @relation(fields: [userId], references: [id])
  module    Module   @relation(fields: [moduleId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, moduleId])
}

model AIModuleDraft {
  id          String         @id @default(cuid())
  title       String
  description String?
  status      AIDraftStatus  @default(PENDING)

  // AI-generated previews
  schemaPreview      Json?
  routesPreview      Json?
  permissionsPreview Json?

  // Who requested/created this draft
  createdByUserId String?
  createdByUser   User?   @relation(fields: [createdByUserId], references: [id])

  // Traceability: modules created from this draft
  resultingModules Module[] @relation("ModuleFromDraft")
  
  // If this draft UPDATES an existing module, track which one
  targetModuleSlug String?

  // Review metadata
  reviewedAt       DateTime?
  reviewedByUserId String?
  reviewNote       String?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Indexes
  @@index([status])
  @@index([createdByUserId])
  @@index([targetModuleSlug])
}

model AuditLog {
  id                String           @id @default(cuid())
  action            AuditAction
  entityType        AuditEntityType
  entityId          String

  performedByUserId String?
  performedByUser   User?            @relation("AuditLogPerformedBy", fields: [performedByUserId], references: [id])

  metadata          Json?

  createdAt         DateTime         @default(now())

  // Indexes
  @@index([entityType, entityId])
  @@index([performedByUserId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, action])
}


